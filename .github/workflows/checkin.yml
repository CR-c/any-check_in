name: Anyroute Daily Check-in

on:
  # 定时执行：每4小时执行一次
  schedule:
    - cron: '0 0 * * *'   # UTC 0:00 = 北京时间 8:00
    - cron: '0 4 * * *'   # UTC 4:00 = 北京时间 12:00
    - cron: '0 8 * * *'   # UTC 8:00 = 北京时间 16:00
    - cron: '0 12 * * *'  # UTC 12:00 = 北京时间 20:00
    - cron: '0 16 * * *'  # UTC 16:00 = 北京时间 0:00
    - cron: '0 20 * * *'  # UTC 20:00 = 北京时间 4:00

  # 支持手动触发
  workflow_dispatch:

jobs:
  checkin:
    runs-on: ubuntu-latest

    # 添加必要的权限
    permissions:
      contents: read
      actions: write

    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync
          uv run camoufox fetch

      - name: Show current time
        run: |
          echo "当前时间: $(date '+%Y-%m-%d %H:%M:%S %Z')"

      - name: Run check-in script
        env:
          # GitHub 环境变量（用于检查今日签到状态）
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

          # 多账号模式（推荐）：设置 ACCOUNTS secret，格式为 JSON 数组
          # 示例：[{"name":"账号1","email":"user1","password":"pass1"},{"name":"账号2","email":"user2","password":"pass2"}]
          ACCOUNTS: ${{ secrets.ACCOUNTS }}

          # 单账号模式（兼容模式）：设置 ANYROUTE_EMAIL 和 ANYROUTE_PASSWORD
          ANYROUTE_EMAIL: ${{ secrets.ANYROUTE_EMAIL }}
          ANYROUTE_PASSWORD: ${{ secrets.ANYROUTE_PASSWORD }}

          # 可选配置
          ANYROUTE_BASE_URL: ${{ secrets.ANYROUTE_BASE_URL }}

          # 邮件通知配置（可选）
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          uv run python checkin.py

      - name: Check-in completed
        if: success()
        run: echo "✓ Check-in completed successfully at $(date '+%Y-%m-%d %H:%M:%S %Z')"

      - name: Check-in failed
        if: failure()
        run: echo "✗ Check-in failed at $(date '+%Y-%m-%d %H:%M:%S %Z'). Please check the logs."
